rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- PROFIL DES UTILISATEURS ---
    // Logique :
    // - L'utilisateur doit être connecté (auth != null)
    // - On va chercher son profil en utilisant son email (c'est notre clé)
    // - On stocke ses infos de profil dans une variable 'profil'
    function getProfil() {
      return get(/databases/$(database)/documents/profils/$(request.auth.token.email)).data;
    }
    // Fonction pour vérifier si on est Admin
    function isAdmin() {
      return getProfil().role == 'Admin';
    }
    // Fonction pour vérifier si on est au moins "Acteur"
    function isActeur() {
      return getProfil().role in ['Admin', 'Acteur'];
    }

    // --- REGLES D'ACCES ---

    // Collection "profils"
    match /profils/{email} {
      // Un admin peut tout faire (créer/inviter, modifier les rôles, supprimer)
      allow read, write: if isAdmin();
      
      // Un utilisateur peut lire son propre profil (pour la vérification)
      allow get: if request.auth.token.email == email;
      // Un utilisateur peut mettre à jour son 'user_auth_id' lors de la 1ère connexion
      allow update: if request.auth.token.email == email 
                      && request.resource.data.keys().hasOnly(['user_auth_id']);
    }

    // Collection "evenements"
    match /evenements/{eventId} {
      allow read: if isActeur(); // Seuls les Acteurs et Admins peuvent voir
      allow create, update: if isAdmin(); // Seuls les Admins peuvent créer/modifier un événement
    }

    // Collection "actions"
    match /actions/{actionId} {
      allow read: if isActeur();
      allow write: if isActeur(); // Les Acteurs peuvent mettre à jour les statuts
    }
    
    // Collection "historique_actions" (ne devrait être écrite que par le backend)
    match /historique_actions/{logId} {
      allow read: if isActeur();
      allow write: if false; // INTERDIT d'écrire depuis le client (géré par Cloud Function)
    }

    // Collection "templates_actions"
    match /templates_actions/{templateId} {
      allow read: if isActeur();
      allow write: if isAdmin(); // Seuls les Admins gèrent les templates
    }
  }
}

